image:
  repository: jgeusebroek/spotweb
  pullPolicy: IfNotPresent
  tag: latest@sha256:a92edf244cbb794fb5cd10d8b3ff808cbf7c0b689bbc01cb9911288f1b467518

# See more environment variables in the babybuddy documentation
# https://hub.docker.com/r/jgeusebroek/spotweb
env:
  # TZ:
  SPOTWEB_CRON_RETRIEVE: "*/15 * * * *"

envTpl:
  SPOTWEB_DB_TYPE: "pdo_pgsql"
  SPOTWEB_DB_NAME: "{{ .Values.postgresql.postgresqlDatabase }}"
  SPOTWEB_DB_USER: "{{ .Values.postgresql.postgresqlUsername }}"
  SPOTWEB_DB_PORT: "5432"

envValueFrom:
  SPOTWEB_DB_PASS:
    secretKeyRef:
      name: dbcreds
      key: postgresql-password
  SPOTWEB_DB_HOST:
    secretKeyRef:
      name: dbcreds
      key: plainhost

initContainers:
  spotweb-init-db:
    image: "{{ .Values.image.repository }}:{{ .Values.image.tag }}"
    command: [ "php" ]
    args:
      - "-f"
      - "/var/www/spotweb/bin/upgrade-db.php"
      - "--"
      - "-reset-password"
      - "admin"
      - "-set-systemtype"
      - "single"
    securityContext:
      runAsUser: 0
      runAsGroup: 0
      readOnlyRootFilesystem: false
      allowPrivilegeEscalation: false
      runAsNonRoot: false
    env:
      - name: SPOTWEB_DB_TYPE
        value: "pdo_pgsql"
      - name: SPOTWEB_DB_NAME
        value: "{{ .Values.postgresql.postgresqlDatabase }}"
      - name: SPOTWEB_DB_USER
        value: "{{ .Values.postgresql.postgresqlUsername }}"
      - name: SPOTWEB_DB_PORT
        value: "5432"
      - name: SPOTWEB_DB_PASS
        valueFrom:
          secretKeyRef:
            name: dbcreds
            key: postgresql-password
      - name: SPOTWEB_DB_HOST
        valueFrom:
          secretKeyRef:
            name: dbcreds
            key: plainhost
    volumeMounts:
      - name: config
        mountPath: "/config"

securityContext:
  readOnlyRootFilesystem: false
  allowPrivilegeEscalation: false
  runAsNonRoot: false

podSecurityContext:
  runAsUser: 0
  runAsGroup: 0

service:
  main:
    ports:
      main:
        port: 11000
        targetPort: 80

persistence:
  config:
    enabled: true
    mountPath: "/config"

# Enabled postgres
postgresql:
  enabled: true
  existingSecret: "dbcreds"
  postgresqlUsername: spotweb
  postgresqlDatabase: spotweb
